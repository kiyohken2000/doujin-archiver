# Doujin Archiver

同人誌のダウンロードと整理を自動化するPythonスクリプトです。毎日の更新情報を自動取得し、体系的なファイル名で保存します。

## ✨ 主な機能

- 🔄 **自動日付リトライ** - 今日の更新が見つからない場合、自動的に過去の日付を検索
- 📅 **複数日対応** - 最大3日前まで自動的に遡って更新を取得
- 📥 **自動ダウンロード** - PDFファイルを自動でダウンロード
- 📁 **整理されたファイル命名** - イベント名、サークル名、原作名による体系的な命名
- 🎪 **イベント名の統一** - コミケのイベント名を「Cxxx」形式に自動変換（例：C104, C105）
- 🔄 **重複防止** - ダウンロード履歴による重複ダウンロードの防止
- ⏱️ **タイムアウト機能** - 5分以上かかるダウンロードは自動スキップ
- 📝 **詳細なログ** - 処理状況を詳細に記録

## 🚀 新機能：自動日付リトライ

**もう手動で日付を変更する必要はありません！**

スクリプトが自動的に以下の処理を行います：
1. まず今日の更新を検索
2. 見つからない場合は1日前を検索
3. 最大3日前まで順番に遡って検索
4. 見つかった日付の更新をダウンロード

## 📋 必要な環境

- Python 3.6以上
- 以下のライブラリ：
  ```
  requests
  beautifulsoup4
  ```

## 🛠️ セットアップ

1. **リポジトリのクローン**
   ```bash
   git clone https://github.com/kiyohken2000/doujin-archiver.git
   cd doujin-archiver
   ```

2. **必要なライブラリのインストール**
   ```bash
   pip install -r requirements.txt
   ```

## 📖 使い方

### 基本的な実行

```bash
python doujin_downloader.py
```

**これだけでOK！** スクリプトが自動的に：
- 今日の更新をチェック
- 見つからなければ自動的に過去の日付を検索
- 見つかった更新をダウンロード

### 実行例

```
==================================================
今日 (2025年10月18日) の更新を検索中...
==================================================
今日の更新アイテムが見つかりませんでした。1日前を検索します...

==================================================
1日前 (2025年10月17日) の更新を検索中...
==================================================
✓ 2025年10月17日の更新アイテムが見つかりました！
処理対象: 2025年10月17日の更新アイテム 15件
```

### ⏰ 実行タイミングについて

**同人すまーとは毎日だいたい21～23時に更新されます。**

- ✅ **ベストタイミング：** 更新後すぐ（21～23時台）に実行
- ✅ **OK：** 日付が変わった後でも自動リトライするので問題なし
- 📝 **メモ：** 最大3日前まで自動的に検索します

## ⚙️ 設定のカスタマイズ

スクリプト内の定数で動作をカスタマイズできます：

```python
DOWNLOAD_DIR = 'downloads'        # ダウンロード先ディレクトリ
DOWNLOAD_TIMEOUT = 300            # タイムアウト時間（秒）
MAX_RETRY_DAYS = 1                # 最大何日前まで遡るか
```

### 遡る日数を変更する

もっと過去まで遡りたい場合は `MAX_RETRY_DAYS` を変更：

```python
MAX_RETRY_DAYS = 7  # 1週間前まで遡る
```

## 📁 ファイル命名規則

ダウンロードされたPDFは以下の優先順位で命名されます：

1. **イベント名がある場合**
   ```
   (イベント名)[サークル名]原作名.pdf
   例: (C104)[サークル名]東方Project.pdf
   ```

2. **発行日がある場合**
   ```
   [サークル名]原作名 発行日.pdf
   例: [サークル名]東方Project 2024-08-12.pdf
   ```

3. **更新日のみの場合**
   ```
   [サークル名]原作名 更新日.pdf
   例: [サークル名]東方Project 2024-10-04.pdf
   ```

### コミケイベント名の自動変換

コミケ関連のタグは自動的に統一形式に変換されます：

| 元のタグ | 変換後 |
|---------|--------|
| 2024年夏コミ(C104) | C104 |
| 2024年夏コミ | C104 |
| 2024年冬コミ | C105 |
| コミックマーケット104 | C104 |

## 💾 ダウンロード履歴

- ダウンロード済みのURLは `downloaded_history.pkl` に保存
- 同じファイルの重複ダウンロードを自動的に防止
- 履歴をリセットする場合は、このファイルを削除してください

```bash
# 履歴をリセット
rm downloaded_history.pkl
```

## ⏱️ タイムアウト機能

- 1つのPDFのダウンロードに5分以上かかる場合、自動的にスキップ
- 不完全なファイルは自動削除され、次のダウンロードに進みます
- サーバー負荷軽減のため、各ダウンロード間に3秒の待機時間を設定

## 📝 ログの確認

- **コンソール出力** - 実行中の処理状況をリアルタイムで表示
- **ログファイル** - `doujin_downloader.log` に詳細な履歴を保存

ログファイルには以下の情報が記録されます：
- 検索した日付と結果
- ダウンロードの成功/失敗
- エラー内容
- 処理時間

## 🔧 トラブルシューティング

### ダウンロードが始まらない
- インターネット接続を確認
- 対象サイトがアクセス可能か確認
- ログファイルでエラー内容を確認

### ファイル名が文字化けする
- Windowsの場合、ファイル名に使用できない文字は自動的に変換されます
- コロン（:）は全角（：）に、その他の記号は半角スペースに変換

### 過去の日付まで遡っても見つからない
- `MAX_RETRY_DAYS` の値を増やしてみてください
- サイトの更新頻度を確認してください

### 特定の日付を手動で指定したい場合
通常は必要ありませんが、特定の日付を指定したい場合は、`main()` 関数内で以下のように変更：

```python
# 自動検索の代わりに特定の日付を指定
target_date = datetime(2025, 10, 15)  # 2025年10月15日を指定
items, used_date = get_items_by_date(target_date)
```

## ⚠️ 注意事項

**重要な注意点**

- 対象サイトの利用規約を遵守してください
- サーバーに過度な負荷をかけないよう、適切な間隔でダウンロードします
- このスクリプトは個人的な使用を想定しています
- 著作権法を遵守し、ダウンロードしたコンテンツの取り扱いには十分注意してください

## 📄 ライセンス

MIT License

## 🚫 免責事項

このツールの使用によって生じたいかなる問題、損害、法的責任について、作者は一切の責任を負いません。利用者の責任において、関連する法律、規約、ガイドラインを遵守してご使用ください。

## 🤝 貢献

バグ報告や機能改善の提案は、GitHubのIssuesでお願いします。